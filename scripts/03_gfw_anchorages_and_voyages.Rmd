---
title: "Dominica: Identify anchorages in Dominica and voyages starting or ending there"
output: html_document
date: "2023-05-01"
---

```{r setup, include=FALSE}
# Packages
library(DBI)
library(bigrquery)
library(networkD3) # Make flow diagram
library(webshot) # Save static version of flow diagram

# Load common helper script
source(here::here("common.R"))

# Load reserve boundaries
load(here::here("results", "reserve_boundaries.Rdata"))
```

# Introduction

This script queries the GFW port and voyages tables to find trips that start/end in Dominica. 

# Identify ports/anchorages in Dominica

```{r}
sql_port_index <- "#StandardSQL

  # Select Anchorage information for all ports in Dominica
  
  SELECT 
    s2id AS anchorage_id,
    label AS anchorage_name,
    sublabel AS anchorage_sublabel,
    lat,
    lon,
    total_visits,
    top_destination,
    iso3,
    distance_from_shore_m,
    dock
  FROM 
    `world-fishing-827.anchorages.named_anchorages_v20230302`
  WHERE 
    iso3 = 'DMA'
  ORDER BY anchorage_name"
```

```{r query-port-index, eval=F}
# Table to save output
port_index_table <- bq_table(project = bq_project,
                             table = "port_index",
                             dataset = "dominica")

if(bq_table_exists(port_index_table)){
  bq_table_delete(port_index_table)
}else{
  bq_table_create(port_index_table)
}

# Run query - We have 25 named anchorages 
dom_ports <- bq_project_query(bq_project, 
                              query = sql_port_index,
                              destination_table = port_index_table,
                              use_legacy_sql = FALSE,
                              allowLargeResults = TRUE) %>%
  bq_table_download()

# Save locally too
write_csv(dom_ports, file.path(prj_cachalote_dir, "data", "processed", "dominica_anchorages_gfw.csv"))
```

```{r}
# Make ports spatial
dom_ports_sf <- dom_ports %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = 4326,
           remove = F) %>%
  sf::st_transform(crs = st_crs(prj_moll)) # convert points to Mollewide

# Plot 
anchorages_plot <- ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "grey", size = 0.2)+
  geom_sf(data = reserve_boundaries_sf, aes(fill = scenario), alpha = 0.4)+
  geom_sf(data = dom_ports_sf, aes(size = total_visits, color = anchorage_name), alpha = 0.3)+
  coord_sf(xlim = plot_bbox$xlim, ylim = plot_bbox$ylim)+
  theme_basic()+
  guides(color = guide_legend(title = "Name", nrow = 3),
         fill = "none",
         size = guide_legend(title = "Total visits"))+
  labs(title = "Named anchorages in Dominica identified by GFW")

ggsave(file.path(prj_cachalote_dir, "figures", "dominica_anchorages.png"), anchorages_plot, height = 8, width = 8)

anchorages_plot
```

```{r}
# Now calculate centroid by group
dom_ports_centroid_sf <- dom_ports_sf %>%
  mutate(port_group = case_when(anchorage_name == "PORTSMOUTH" ~ "Portsmouth",
                                anchorage_name %in% c("ROSEAU", "POINTE MICHEL") ~ "Roseau/Pointe Michel",
                                anchorage_name %in% c("DMA-4", "SAINT JOSEPH") ~ "Saint Joseph/Salisbury")) %>%
  group_by(port_group) %>%
  mutate(lat_cen = mean(lat),
         lon_cen = mean(lon)) %>%
  ungroup() %>%
  st_drop_geometry() %>%
  st_as_sf(coords = c("lon_cen", "lat_cen"),
           crs = 4326,
           remove = F) %>%
  sf::st_transform(crs = st_crs(prj_moll)) # convert points to Mollewide

# Plot 
anchorage_centroid_plot <- ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "grey", size = 0.2)+
  geom_sf(data = reserve_boundaries_sf, aes(fill = scenario), alpha = 0.3)+
  geom_sf(data = dom_ports_centroid_sf, aes(color = port_group))+
  coord_sf(xlim = plot_bbox$xlim, ylim = plot_bbox$ylim)+
  theme_basic()+
  guides(color = guide_legend(title = "Anchorage group", nrow = 3),
         fill = "none")+
  labs(title = "Anchorage groups in Dominica identified by GFW")

ggsave(file.path(prj_cachalote_dir, "figures", "dominica_anchorage_groups.png"), anchorage_centroid_plot, height = 8, width = 8)

anchorage_centroid_plot
```

```{r}
# Save anchorage information
save(dom_ports_centroid_sf, 
     file = file.path(prj_cachalote_dir, "data", "processed", "dominica_anchorage_centroids_gfw.Rdata"))
```

# Identify voyages starting or ending at anchorages in Dominica

```{r}
sql_dom_voyages <- "WITH 

  #########################
  # Anchorage info we want to add to this table

  anchorages AS (
      SELECT
        s2id AS anchorage_id,
        label AS anchorage_name,
        sublabel AS anchorage_sublabel,
        iso3
      FROM 
        `world-fishing-827.anchorages.named_anchorages_v20230302`
  ),

  #########################
  # List of known bad mmsi numbers

  bad_mmsi AS (
      SELECT
        ssvid
      FROM
        `world-fishing-827.gfw_research.bad_mmsi`
      CROSS JOIN
      UNNEST(ssvid) AS ssvid
  ),
  
  #########################
  # All voyages by vessels with a port visit confidence 4 - if we want to lower this confidence, we'll need to pull from a different table
  
  good_voyages AS(
      SELECT 
        *,
        EXTRACT(YEAR FROM trip_start) AS start_year,
        EXTRACT(YEAR FROM trip_end) AS end_year
      FROM  
        `world-fishing-827.pipe_production_v20201001.proto_voyages_c4`
      WHERE
        EXTRACT(YEAR FROM trip_start) > 2016 
        AND EXTRACT(YEAR FROM trip_end) < 2023
        AND CAST(ssvid AS int64) NOT IN (
                  SELECT
                    ssvid
                  FROM
                    bad_mmsi)
          AND trip_start_anchorage_id IN (
                  SELECT
                    anchorage_id
                  FROM
                    `emlab-gcp.dominica.port_index`)
      UNION ALL
      SELECT 
        *,
        EXTRACT(YEAR FROM trip_start) AS start_year,
        EXTRACT(YEAR FROM trip_end) AS end_year
      FROM  
        `world-fishing-827.pipe_production_v20201001.proto_voyages_c4`
      WHERE
        EXTRACT(YEAR FROM trip_start) > 2016 
        AND EXTRACT(YEAR FROM trip_end) < 2023
        AND CAST(ssvid AS int64) NOT IN (
                  SELECT
                    ssvid
                  FROM
                    bad_mmsi)
          AND trip_end_anchorage_id IN (
                  SELECT
                    anchorage_id
                  FROM
                    `emlab-gcp.dominica.port_index`)
          AND trip_start_anchorage_id NOT IN (
                  SELECT
                    anchorage_id
                  FROM
                    `emlab-gcp.dominica.port_index`)
      )


  SELECT 
    ssvid,
    trip_id,
    trip_start AS start_timestamp,
    start_year,
    trip_start_visit_id AS start_visit_id,
    g.trip_start_anchorage_id as start_anchorage_id,
    c.anchorage_name AS start_anchorage_name,
    c.anchorage_sublabel AS start_anchorage_sublabel,
    c.iso3 AS start_iso3,
    IF(c.iso3 = 'DMA', TRUE, FALSE) AS start_is_DMA,
    trip_end AS end_timestamp,
    end_year,
    g.trip_end_anchorage_id as end_anchorage_id,
    d.anchorage_name AS end_anchorage_name,
    d.anchorage_sublabel AS end_anchorage_sublabel,
    d.iso3 AS end_iso3,
    IF(d.iso3 = 'DMA', TRUE, FALSE) AS end_is_DMA,
    DATETIME_DIFF(trip_end, trip_start, MINUTE)/60 AS voyage_duration_h
  FROM good_voyages as g
  INNER JOIN anchorages as c
  ON g.trip_start_anchorage_id = c.anchorage_id
  INNER JOIN anchorages as d
  ON g.trip_end_anchorage_id = d.anchorage_id"
```

```{r query-voyages, eval=F}
# Table to save output
voyage_table <- bq_table(project = bq_project,
                         table = "dominica_voyages_2017_2022",
                         dataset = "dominica")

if(bq_table_exists(voyage_table)){
  bq_table_delete(voyage_table)
}else{
  bq_table_create(voyage_table)
}

# Run query
dom_voyages <- bq_project_query(bq_project, 
                                query = sql_dom_voyages,
                                destination_table = voyage_table,
                                use_legacy_sql = FALSE,
                                allowLargeResults = TRUE) %>%
  bq_table_download()

# Save locally too
write_csv(dom_voyages, file.path(prj_cachalote_dir, "data", "processed", "dominica_voyages_gfw_2017_2022.csv"))
```

# Summarize

First, lets figure out how many inbound, outgoing, and domestic voyages we have between 2017 and 2022. Then let's make sure we don't have any voyages that don't meet one of these three classifications.  

```{r}
# 2,068 domestic voyages (starting and ending in Dominica)
domestic_voyages <- dom_voyages %>%
  dplyr::filter(start_is_DMA & end_is_DMA) %>%
  distinct(trip_id)

# 10,837 inbound voyages
in_voyages <- dom_voyages %>%
  dplyr::filter(!start_is_DMA & end_is_DMA) %>%
  distinct(trip_id)

# 11,078 outgoing voyages
out_voyages <- dom_voyages %>%
  dplyr::filter(start_is_DMA & !end_is_DMA) %>%
  distinct(trip_id)

# 23,983 total voyages
all_voyages <- c(domestic_voyages$trip_id, in_voyages$trip_id, out_voyages$trip_id)

# Are we missing any? No. 
other_voyages <- dom_voyages %>%
  dplyr::filter(!(trip_id %in% all_voyages)) %>%
  distinct(trip_id)

# Do we have duplicate rows in our voyage table? No. 
n_rows_per_trip <- dom_voyages %>%
  group_by(trip_id, ssvid) %>%
  summarize(n_rows = n()) %>%
  dplyr::filter(n_rows > 1)
```

```{r}
# Let's do some simple classifications for our voyages: 
voyage_classification <- dom_voyages %>%
  mutate(classification = case_when(trip_id %in% domestic_voyages$trip_id ~ "Domestic",
                                    trip_id %in% in_voyages$trip_id ~ "Inbound",
                                    trip_id %in% out_voyages$trip_id ~ "Outbound")) %>%
  group_by(classification) %>%
  summarize(n_voyages = n(),
            average_duration = mean(voyage_duration_h),
            total_duration = sum(voyage_duration_h),
            min_duration = min(voyage_duration_h),
            max_duration = max(voyage_duration_h))

head(voyage_classification)
```

## Get maps of start/end anchorages outside of Dominica

```{r}
other_anchorage_sql <- 'WITH

  ports as (
    SELECT 
      *,
      "origin" as type
    FROM 
      `world-fishing-827.anchorages.named_anchorages_v20230302`
    WHERE 
      s2id IN (
        SELECT DISTINCT
          start_anchorage_id
        FROM
          `emlab-gcp.dominica.dominica_voyages_2017_2022`
        WHERE
          start_is_DMA = FALSE
      )
    UNION ALL
    SELECT 
      *,
      "destination" as type
    FROM 
    `world-fishing-827.anchorages.named_anchorages_v20230302`
    WHERE 
      s2id IN (
        SELECT DISTINCT
          end_anchorage_id
        FROM
          `emlab-gcp.dominica.dominica_voyages_2017_2022`
        WHERE
          end_is_DMA = FALSE
      )
  )

  SELECT DISTINCT
    type,
    s2id AS anchorage_id,
    label AS anchorage_name,
    sublabel AS anchorage_sublabel,
    lat,
    lon,
    total_visits,
    top_destination,
    iso3,
    distance_from_shore_m,
    dock
  FROM 
    ports 
  ORDER BY
    iso3,
    anchorage_name'
```

```{r query-voyages, eval=F}
# Table to save output
other_anchorage_table <- bq_table(project = bq_project,
                            table = "all_relevant_ports",
                            dataset = "dominica")

if(bq_table_exists(other_anchorage_table)){
  bq_table_delete(other_anchorage_table)
}else{
  bq_table_create(other_anchorage_table)
}

# Run query
other_ports <- bq_project_query(bq_project, 
                                query = other_anchorage_sql,
                                destination_table = other_anchorage_table,
                                use_legacy_sql = FALSE,
                                allowLargeResults = TRUE) %>%
  bq_table_download()
```

```{r}
other_ports_sf <- other_ports %>%
  group_by(anchorage_id) %>%
  mutate(category = case_when(length(type) == 2 ~ "Both",
                              type == "origin" ~ "Origin",
                              type == "destination" ~ "Destination"),
         category = factor(category, levels = c("Origin", "Destination", "Both"))) %>%
  distinct(anchorage_id, anchorage_name, lat, lon, iso3, category) %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = 4326,
           remove = F) %>%
  sf::st_transform(crs = st_crs(prj_moll)) # convert points to Mollewide

# Plot 
other_port_plot <- ggplot()+
  #geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "grey", size = 0.2)+
  #geom_sf(data = reserve_boundaries_sf, aes(fill = scenario), alpha = 0.3)+
  geom_sf(data = other_ports_sf, aes(color = category), size = 0.5)+
  #coord_sf(xlim = plot_bbox$xlim, ylim = plot_bbox$ylim)+
  theme_basic()+
  map_layer_moll+
  guides(color = guide_legend(title = "Anchorage group", nrow = 3),
         fill = "none")+
  labs(title = "Start and end ports for voyages to Dominica as identified by GFW")

ggsave(file.path(prj_cachalote_dir, "figures", "dominica_start_and_end_ports.png"), other_port_plot, height = 8, width = 8)

other_port_plot
```

### Correct mislabeled port ISO3 codes

We've noticed that the distances traveled for certain start/end ports based on ISO 3 code don't seem right. Particularly the following: 
- FRA

Let's look closer at these and relabel them if necessary

```{r}
# Get french ports
fra_ports <- other_ports_sf %>%
  dplyr::filter(iso3 == "FRA")

# Take a look - We've definitely got three countries in the Caribbean that shouldn't be labeled as "FRA"
fra_port_plot <- ggplot()+
  geom_sf(data = fra_ports, aes(color = category), size = 1)+
  theme_basic()+
  map_layer_moll+
  guides(color = guide_legend(title = "Anchorage group", nrow = 3),
         fill = "none")

fra_port_plot
```

```{r}
# Fix the mislabeled ports
# LE GOSIER, DESHAIES, BAIE DU MARIGOT are in Guadeloupe
# SCHOELCHER is in Martineque; MTQ-16 is probably in Martinique
# ST MARTIN is in Saint Martin; MAF-2 is probably in Saint Martin
fra_ports_fix <- fra_ports %>%
  dplyr::filter(lat < 20 & lon < -50) %>%
  mutate(iso3_fixed = case_when(anchorage_name %in% c("BAIE DU MARIGOT", "DESHAIES", "LE GOSIER") ~ "GLP",
                              anchorage_name %in% c("MAF-2", "ST MARTIN") ~ "MAF",
                              anchorage_name %in% c("MTQ-16", "SCHOELCHER") ~ "MTQ")) %>%
  st_drop_geometry()

# Now add these back to the port lookup file
other_ports_out <- other_ports_sf %>%
  left_join(fra_ports_fix %>% dplyr::select(anchorage_id, iso3_fixed), by = "anchorage_id") %>%
  mutate(iso3_fixed = ifelse(!is.na(iso3_fixed), iso3_fixed, iso3))

# Save locally too
save(other_ports_out, file = file.path(prj_cachalote_dir, "data", "processed", "origin_and_destination_ports.Rdata"))
```

## Frequency of voyages by start/end country

```{r}
# Summarize by start/end - country level only
freq_voyages_by_iso3 <- dom_voyages %>%
 mutate(classification = case_when(trip_id %in% domestic_voyages$trip_id ~ "Domestic",
                                    trip_id %in% in_voyages$trip_id ~ "Inbound",
                                    trip_id %in% out_voyages$trip_id ~ "Outbound")) %>%
  group_by(classification, start_iso3, end_iso3) %>%
  summarize(n_voyages = n_distinct(trip_id),
            avg_duration_h = mean(voyage_duration_h))
```


```{r}
# Summarize by start/end - country level only
freq_voyages_by_iso3_and_year <- dom_voyages %>%
  mutate(classification = case_when(trip_id %in% domestic_voyages$trip_id ~ "Domestic",
                                    trip_id %in% in_voyages$trip_id ~ "Inbound",
                                    trip_id %in% out_voyages$trip_id ~ "Outbound")) %>%
  group_by(start_year, classification, start_iso3, end_iso3) %>%
  summarize(n_voyages = n_distinct(trip_id),
            avg_duration_h = mean(voyage_duration_h))
```

```{r}
# Plot flow diagram of voyages to Dominica
links_in <- freq_voyages_by_iso3 %>%
  ungroup() %>%
  dplyr::filter(start_iso3 != "DMA" & end_iso3 == "DMA") %>%
  dplyr::select(source = start_iso3, target = end_iso3, value = n_voyages)
links_in$source <- paste(links_in$source, " ", sep="")

# Plot flow diagram of total landings made in each country that go toward each destination
links_out <- freq_voyages_by_iso3 %>%
  ungroup() %>%
  dplyr::filter(start_iso3 == "DMA") %>%
  dplyr::select(source = start_iso3, target = end_iso3, value = n_voyages)

# Join to previous df
links_all <- links_in %>%
  bind_rows(links_out)

nodes <- tibble(name=c(as.character(links_all$source), as.character(links_all$target)) %>% unique()) %>%
  mutate(region = countrycode(str_replace(name, " ", ""), "iso3c", "region"),
         group = case_when(region == "Latin America & Caribbean" ~ "group_1",
                           region == "Sub-Saharan Africa" ~ "group_2",
                           region == "Europe & Central Asia" ~ "group_3",
                           region == "North America" ~ "group_4",
                           T ~ "group_5"),
         group = as.factor(group)) %>%
  as.data.frame()

# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
links_all$IDsource=match(links_all$source, nodes$name)-1 
links_all$IDtarget=match(links_all$target, nodes$name)-1

# Color scale
# rev(RColorBrewer::brewer.pal(3, "Set2"))
my_color <- 'd3.scaleOrdinal() .domain(["group_1", "group_2", "group_3", "group_4", "group_5"]) .range(["#8DA0CB", "#FC8D62", "#66C2A5", "#6ca992", "grey"])'

# Make plot
sn <- sankeyNetwork(Links = links_all, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              sinksRight=F, nodeWidth=40, fontSize=13, nodePadding=20,
              iterations = 100,
              units = "Voyages",
              NodeGroup ="group",
              colourScale = my_color)

# Save
saveNetwork(sn, file.path(prj_cachalote_dir, "figures", "voyages_in_and_out_of_dominica_by_iso3.html"))

# # And convert to a static PNG version
# webshot(here("results", "voyages_in_and_out_of_dominica_by_iso3.html"),
#         here("results", "voyages_in_and_out_of_dominica_by_iso3.png"), vwidth = 2500, vheight = 1500)

sn
```

```{r}
# Summarize by start/end - by port are within Dominica
freq_voyages_by_iso3_and_port <- dom_voyages %>%
  mutate(start_anchor_group = case_when(start_anchorage_name %in% c("POINTE MICHEL", "ROSEAU") ~ "Roseau/Pointe Michel",
                                        start_anchorage_name == "PORTSMOUTH" ~ "Portsmouth",
                                        start_anchorage_name %in% c("DMA-4", "SAINT JOSEPH") ~ "Saint Joseph/Salisbury"),
         end_anchor_group = case_when(end_anchorage_name %in% c("POINTE MICHEL", "ROSEAU") ~ "Roseau/Pointe Michel",
                                      end_anchorage_name == "PORTSMOUTH" ~ "Portsmouth",
                                      end_anchorage_name %in% c("DMA-4", "SAINT JOSEPH") ~ "Saint Joseph/Salisbury")) %>%
  mutate(start = ifelse(start_iso3 == "DMA", start_anchor_group, start_iso3),
         end = ifelse(end_iso3 == "DMA", end_anchor_group, end_iso3)) %>%
  group_by(start_year, start, end) %>%
  summarize(n_voyages = n_distinct(trip_id),
            avg_duration_h = mean(voyage_duration_h))

# Remove those with the same start/end destination
freq_voyages_by_iso3_and_port <- freq_voyages_by_iso3_and_port %>%
  dplyr::filter(start != end)
```

```{r}
# Plot flow diagram of voyages to Dominica
links_in_p <- freq_voyages_by_iso3_and_port %>%
  ungroup() %>%
  dplyr::filter(end %in% c("Roseau/Pointe Michel", "Saint Joseph/Salisbury", "Portsmouth")) %>%
  dplyr::select(source = start, target = end, value = n_voyages)
links_in_p$source <- paste(links_in_p$source, " ", sep="")

# Plot flow diagram of total landings made in each country that go toward each destination
links_out_p <- freq_voyages_by_iso3_and_port %>%
  ungroup() %>%
  dplyr::filter(start %in% c("Roseau/Pointe Michel", "Saint Joseph/Salisbury", "Portsmouth")) %>%
  dplyr::select(source = start, target = end, value = n_voyages)
links_out_p$target <- paste(links_out_p$target, "  ", sep="")

# Join to previous df
links_all_p <- links_in_p %>%
  bind_rows(links_out_p)

nodes_p <- tibble(name=c(as.character(links_all_p$source), as.character(links_all_p$target)) %>% unique()) %>%
  mutate(region = countrycode(str_replace_all(name, " ", ""), "iso3c", "region"),
         group = case_when(region == "Latin America & Caribbean" ~ "group_1",
                           region == "Sub-Saharan Africa" ~ "group_2",
                           region == "Europe & Central Asia" ~ "group_3",
                           region == "North America" ~ "group_4",
                           T ~ "group_5"),
         group = as.factor(group)) %>%
  as.data.frame()

# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
links_all_p$IDsource=match(links_all_p$source, nodes_p$name)-1 
links_all_p$IDtarget=match(links_all_p$target, nodes_p$name)-1

# Color scale
# rev(RColorBrewer::brewer.pal(3, "Set2"))
my_color <- 'd3.scaleOrdinal() .domain(["group_1", "group_2", "group_3", "group_4", "group_5"]) .range(["#8DA0CB", "#FC8D62", "#66C2A5", "#6ca992", "grey"])'

# Make plot
sn_p <- sankeyNetwork(Links = links_all_p, Nodes = nodes_p,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              sinksRight=F, nodeWidth=40, fontSize=13, nodePadding=20,
              iterations = 500,
              units = "Voyages",
              NodeGroup ="group",
              colourScale = my_color)

# Save
saveNetwork(sn_p, file.path(prj_cachalote_dir, "figures", "voyages_in_and_out_of_dominica_by_iso3_and_port.html"))

# # And convert to a static PNG version
# webshot(here("results", "voyages_in_and_out_of_dominica_by_iso3.html"),
#         here("results", "voyages_in_and_out_of_dominica_by_iso3.png"), vwidth = 2500, vheight = 1500)

sn_p
```


