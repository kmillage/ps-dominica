---
title: "Dominica: Proposed Sperm Whale Reserve Boundaries"
output: html_document
date: "2023-05-01"
---

```{r setup, include=FALSE}
# Load helper script
source(here::here("common.R"))

# Define nautical miles in m
nm <- 1852
```

# Introduction

This script creates shapefiles of potential sperm whales reserves in Dominica according to the following conditions: 
- The North boundary is defined by a line running perpendicular to shore from a specified coordinate (NE);
- The South boundary is defined by a line running perpendicular to shore from a specified coordinate (SE);
- The West boundary is variable, defined by a line running between two points determed based on specified distances from their Eastern counterpoints;
- The East boundary is defined by a line running between the NE and SE corners (NOTE - we may need to refine this later based on the path traveled by the ferry running parallel to shore or some distance from shore).

These potential reserve boundaries will be used in later scripts to identify the fraction of sperm whale sightings that would have occured within each area, as well as the changes in cruise ship, container ship, and tug transit time/cost that would have been required if they were required to transit around the reserve to get to the main port. 

# Vary West Boundary

```{r}
# Distances of the NW and SW corners of the reserve measured from the specified NE and SE coordinates. 
W_distances_top <- c(3*nm, 5*nm, 7*nm) # 3,5,7  nautical miles
W_distances_bottom <- c(6*nm, 8*nm, 10*nm)  # 6,8,10 nautical miles
```

# Set Northeast Reserve Coordinate

```{r}
# Set NE boundary. Starting coordinates eyeballed from map Enric sent.  
NE_pt <- data.frame(coord = "NE")
NE_pt$geom = st_sfc(st_point(c(-61.540650, 15.63)))

# Convert to sf object and specify crs
NE_pt_sf <- st_as_sf(NE_pt)
sf::st_crs(NE_pt_sf) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
NE_pt_sf_moll <- NE_pt_sf %>%
  sf::st_transform(crs = st_crs(prj_moll)) # convert to Mollewide

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = NE_pt_sf_moll)
```

```{r}
# Get mollewide points of NE coordinate
NE_pt_moll <- st_coordinates(NE_pt_sf_moll)

# Create container for NW points
NW_pts_sf_moll <- NULL

# Next, create new points for the potential NW boundary coordinates
for(i in 1:length(W_distances_top)){
  
  # Set NW boundary 
  NW_pt <- data.frame(coord = paste0("NW_", i))
  NW_pt$geom = st_sfc(st_point(c(NE_pt_moll[1]-W_distances_top[i], NE_pt_moll[2])))
  
  # Convert to sf object and assign crs
  NW_pt_sf_moll <- st_as_sf(NW_pt)
  sf::st_crs(NW_pt_sf_moll) <- prj_moll
  
  # Add to object
  NW_pts_sf_moll <- NW_pts_sf_moll %>% 
    bind_rows(NW_pt_sf_moll)
}

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = NW_pts_sf_moll, aes(group = coord))
```

# Set Southeast Reserve Coordinate

```{r}
# Set SE boundary. Coordinates eyeballed from map Enric sent.  
SE_pt <- data.frame(coord = "SE")
SE_pt$geom = st_sfc(st_point(c(-61.384571, 15.190341)))

# Convert to sf object and assign crs
SE_pt_sf <- st_as_sf(SE_pt)
sf::st_crs(SE_pt_sf) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
SE_pt_sf_moll <- SE_pt_sf %>%
  sf::st_transform(crs = st_crs(prj_moll)) # convert to Mollewide

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = SE_pt_sf_moll)
```
```{r}
# Get mollewide points of SE coordinate
SE_pt_moll <- st_coordinates(SE_pt_sf_moll)

SW_pts_sf_moll <- NULL

# Next, create new points for the potential SW boundary coordinates
for(i in 1:length(W_distances_bottom)){
  
  # Set NW boundary 
  SW_pt <- data.frame(coord = paste0("NW_", i))
  SW_pt$geom = st_sfc(st_point(c(SE_pt_moll[1]-W_distances_bottom[i], SE_pt_moll[2])))
  
  # Convert to sf object and assign crs
  SW_pt_sf_moll <- st_as_sf(SW_pt)
  sf::st_crs(SW_pt_sf_moll) <- prj_moll
  
  # Add to object
  SW_pts_sf_moll <- SW_pts_sf_moll %>% 
    bind_rows(SW_pt_sf_moll)
}

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = SW_pts_sf_moll, aes(group = coord))
```

# Combine North, South, and West boundaries

```{r}
# Get corner coordinates 
NW_pts_moll <- st_coordinates(NW_pts_sf_moll)
SW_pts_moll <- st_coordinates(SW_pts_sf_moll)

box_coords_sf_moll <- NULL

for(i in 1:length(W_distances_top)){
  
  # Define box coordinates
  box = list(matrix(c(NE_pt_moll, SE_pt_moll, SW_pts_moll[i,], NW_pts_moll[i,], NE_pt_moll), ncol = 2, byrow = T))
  box_poly <- st_polygon(box)
  
  box_moll <- data.frame(scenario = i)
  box_moll$geom <- st_sfc(box_poly)
  
  # Make simple feature object
  box_sf_moll <- st_as_sf(box_moll)
  sf::st_crs(box_sf_moll) <- prj_moll
  
  # Add to object
  box_coords_sf_moll <- box_coords_sf_moll %>% 
    bind_rows(box_sf_moll)
  
}

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = box_coords_sf_moll, aes(group = scenario, fill = scenario), alpha = 0.5)
```

# Refine East Boundary

Later TO-DO - Refine this boundary based on distance from shore or the path traveled by the ferry. 

```{r}
# # Intersect with EEZ file
# E_coords_sf_moll <- st_intersection(box_coords_sf_moll, dominica_eez_sf)
# 
# # Plot - looking good
# ggplot()+
#   geom_sf(data = dominica_eez_sf, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
#   geom_sf(data = E_coords_sf_moll, aes(group = scenario, fill = scenario), alpha = 0.5)
```

```{r}
# # Convert to mollewide
# dom_wc_box_moll <- dom_wc_box %>%
#   sf::st_transform(crs = st_crs(prj_moll)) # convert to Mollewide to make figuring distances easier
# 
# # Now we need to buffer this so we move it offshore a bit. Let's start with 1km offshore
# dom_wc_box_moll_buff <- st_buffer(dom_wc_box_moll, -1000) # This distance should be in m
# 
# # Plot - looking good
# test_plot2 <- ggplot()+
#   geom_sf(data = dom_wc_box_moll, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
#   geom_sf(data = dom_wc_box_moll_buff, aes(group = mrgid), color = "black", fill = "lightblue2", size = 0.2)
# 
# test_plot2
```

# Add Shipping Channel 

We also need to incorporate a shipping channel bisecting the reserve that is 5 miles wild and directly perpendicular to Roseau. 

```{r}
# Shipping lane width in m
shipping_lane_width <- 3*nm
shipping_lane_length <- 12*nm

# Central latitude/longitude of Roseau - directly between the commercial shipping terminal and the cruise ship berth.
roseau_pt <- data.frame(loc = "E_mid")
roseau_pt$geom = st_sfc(st_point(c(-61.391959, 15.299277)))

# Convert to sf object and assign crs
roseau_pt_sf <- st_as_sf(roseau_pt)
sf::st_crs(roseau_pt_sf) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
roseau_pt_sf_moll <- roseau_pt_sf %>%
  sf::st_transform(crs = st_crs(prj_moll)) # convert to Mollewide

# Get coordinates
roseau_pt_moll <- st_coordinates(roseau_pt_sf_moll)

# Create shippings lanes - Top and bottom should be 2.5 nm north and south of point respectively. Each lane is 1 nm, with 3 nm separation lane between them.
  sl = list(matrix(c(roseau_pt_moll[1], roseau_pt_moll[2]+shipping_lane_width/2, # NE
                   roseau_pt_moll[1], roseau_pt_moll[2]-shipping_lane_width/2, # SE
                   roseau_pt_moll[1]-shipping_lane_length, roseau_pt_moll[2]-shipping_lane_width/2, # SW
                   roseau_pt_moll[1]-shipping_lane_length, roseau_pt_moll[2]+shipping_lane_width/2, # NW
                   roseau_pt_moll[1], roseau_pt_moll[2]+shipping_lane_width/2), ncol = 2, byrow = T)) # NE
  sl_box <- st_polygon(sl)
  
  sl_moll <- data.frame(name = "shipping lane")
  sl_moll$geom <- st_sfc(sl_box)
  
  # Make simple feature object
  sl_sf_moll <- st_as_sf(sl_moll)
  sf::st_crs(sl_sf_moll) <- prj_moll

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = box_coords_sf_moll, aes(group = scenario, fill = scenario), alpha = 0.5)+
  geom_sf(data = sl_sf_moll, aes(group = name), fill = "black")
  
```

```{r}
# Subtract shipping channel and summarize
reserve_boundaries_sf <- st_difference(box_coords_sf_moll, sl_sf_moll) %>%
  mutate(area_m2 = st_area(geom),
         area_km2 = as.numeric(area_m2)*1e-6) %>%
  dplyr::select(-name, -area_m2)
  
# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = reserve_boundaries_sf, aes(group = scenario, fill = scenario), alpha = 0.5)
```

```{r}
# Save
save(reserve_boundaries_sf, file = file.path(here::here("results", "reserve_boundaries.Rdata")))
```



