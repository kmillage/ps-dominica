---
title: "Dominica: Proposed Sperm Whale Reserve Boundaries"
output: html_document
date: "2023-05-01"
---

```{r setup, include=FALSE}
source(here::here("common.R"))
```

# Introduction

This script creates shapefiles of potential sperm whales reserves in Dominica according to the following conditions: 
- The North boundary is defined by a line running perpendicular to shore at X degrees Latitude;
- The East boundary is defined by the path traveled by the ferry running parallel to shore (NOTE - for now we will use a buffer from shore of X distance to mimic this. We will fix this later depending on the path traveled by the ferry);
- The South boundary is defined by a line running perpendicular to shore at X degrees Latitude;
- The West boundary is variable, defined by a line running parallel to shore at X-X degrees degrees Longitude.

These shapefiles will be used in later scripts to identify the fraction of sperm whale sightings that occurred within each area, as well as the changes in cruise ship, container ship, and tug transit time/cost to get to the main port

```{r}
# Get EEZ data (Marine Regions v11)
eez_sf <- st_read(file.path(emlab_data_dir, "marine-regions-eez-v11", "World_EEZ_v11_20191118_gpkg", "eez_v11.gpkg")) %>%
  janitor::clean_names() %>%
  dplyr::select(mrgid,
                eez_name = geoname,
                eez_type = pol_type,
                eez_ter1_name = territory1,
                eez_ter1_iso3 = iso_ter1,
                eez_sov1_name = sovereign1,
                eez_ter2_name = territory2,
                eez_ter2_iso3 = iso_ter2,
                eez_sov2_name = sovereign2,
                eez_ter3_name = territory3,
                eez_ter3_iso3 = iso_ter3,
                eez_sov3_name = sovereign3,
                eez_area_km = area_km2) %>%
  sf::st_transform(crs = st_crs(prj_moll)) # convert to Mollewide

# Extract dominica EEZ boundaries
dominica_eez_sf <- eez_sf %>%
  dplyr::filter(mrgid == 8417)
```

# Vary West Boundary

```{r}
# In meters from the Eastern boundary - will be measured from the corners
W_distances_top <- c(5556, 9260, 12964) # 3,5,7  nautical miles
W_distances_bottom <- c(11112, 14816, 18520)  # 6,8,10 nautical miles
```

# Set North Boundary

```{r}
# Set NE boundary. Coordinates eyeballed from map Enric sent.  
NE_pt <- data.frame(coord = "NE")
NE_pt$geom = st_sfc(st_point(c(-61.540650, 15.63)))

# Convert to sf object and assign crs
NE_pt_sf <- st_as_sf(NE_pt)
sf::st_crs(NE_pt_sf) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
NE_pt_sf_moll <- NE_pt_sf %>%
  sf::st_transform(crs = st_crs(prj_moll)) # convert to Mollewide

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = NE_pt_sf_moll)
```

```{r}
# Get mollewide points of NE coordinate
NE_pt_moll <- st_coordinates(NE_pt_sf_moll)

NW_pts_sf_moll <- NULL

# Next, create new points for the potential NW boundary coordinates
for(i in 1:length(W_distances_top)){
  
  # Set NW boundary 
  NW_pt <- data.frame(coord = paste0("NW_", i))
  NW_pt$geom = st_sfc(st_point(c(NE_pt_moll[1]-W_distances_top[i], NE_pt_moll[2])))
  
  # Convert to sf object and assign crs
  NW_pt_sf_moll <- st_as_sf(NW_pt)
  sf::st_crs(NW_pt_sf_moll) <- prj_moll
  
  # Add to object
  NW_pts_sf_moll <- NW_pts_sf_moll %>% 
    bind_rows(NW_pt_sf_moll)
}

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = NW_pts_sf_moll, aes(group = coord))
```

# Set South Boundary

```{r}
# Set SE boundary. Coordinates eyeballed from map Enric sent.  
SE_pt <- data.frame(coord = "SE")
SE_pt$geom = st_sfc(st_point(c(-61.384571, 15.190341)))

# Convert to sf object and assign crs
SE_pt_sf <- st_as_sf(SE_pt)
sf::st_crs(SE_pt_sf) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
SE_pt_sf_moll <- SE_pt_sf %>%
  sf::st_transform(crs = st_crs(prj_moll)) # convert to Mollewide

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = SE_pt_sf_moll)
```
```{r}
# Get mollewide points of SE coordinate
SE_pt_moll <- st_coordinates(SE_pt_sf_moll)

SW_pts_sf_moll <- NULL

# Next, create new points for the potential SW boundary coordinates
for(i in 1:length(W_distances_bottom)){
  
  # Set NW boundary 
  SW_pt <- data.frame(coord = paste0("NW_", i))
  SW_pt$geom = st_sfc(st_point(c(SE_pt_moll[1]-W_distances_bottom[i], SE_pt_moll[2])))
  
  # Convert to sf object and assign crs
  SW_pt_sf_moll <- st_as_sf(SW_pt)
  sf::st_crs(SW_pt_sf_moll) <- prj_moll
  
  # Add to object
  SW_pts_sf_moll <- SW_pts_sf_moll %>% 
    bind_rows(SW_pt_sf_moll)
}

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = SW_pts_sf_moll, aes(group = coord))
```

# Combine North, South, and West boundaries

```{r}
# Get corner coordinates 
NW_pts_moll <- st_coordinates(NW_pts_sf_moll)
SW_pts_moll <- st_coordinates(SW_pts_sf_moll)

box_coords_sf_moll <- NULL

for(i in 1:length(W_distances_top)){
  
  # Define box coordinates
  box = list(matrix(c(NE_pt_moll, SE_pt_moll, SW_pts_moll[i,], NW_pts_moll[i,], NE_pt_moll), ncol = 2, byrow = T))
  box_poly <- st_polygon(box)
  
  box_moll <- data.frame(scenario = i)
  box_moll$geom <- st_sfc(box_poly)
  
  # Make simple feature object
  box_sf_moll <- st_as_sf(box_moll)
  sf::st_crs(box_sf_moll) <- prj_moll
  
  # Add to object
  box_coords_sf_moll <- box_coords_sf_moll %>% 
    bind_rows(box_sf_moll)
  
}

# Plot 
ggplot()+
  geom_sf(data = dominica_eez_sf, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
  geom_sf(data = box_coords_sf_moll, aes(group = scenario, fill = scenario), alpha = 0.5)
```

# Set East Boundary

Later TO-DO - Refine this boundary based on distance from shore so this boundary isn't a horizontal line

```{r}
# # Intersect with EEZ file
# E_coords_sf_moll <- st_intersection(box_coords_sf_moll, dominica_eez_sf)
# 
# # Plot - looking good
# ggplot()+
#   geom_sf(data = dominica_eez_sf, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
#   geom_sf(data = E_coords_sf_moll, aes(group = scenario, fill = scenario), alpha = 0.5)
```

```{r}
# # Convert to mollewide
# dom_wc_box_moll <- dom_wc_box %>%
#   sf::st_transform(crs = st_crs(prj_moll)) # convert to Mollewide to make figuring distances easier
# 
# # Now we need to buffer this so we move it offshore a bit. Let's start with 1km offshore
# dom_wc_box_moll_buff <- st_buffer(dom_wc_box_moll, -1000) # This distance should be in m
# 
# # Plot - looking good
# test_plot2 <- ggplot()+
#   geom_sf(data = dom_wc_box_moll, aes(group = mrgid), color = "black", fill = "lightblue4", size = 0.2)+
#   geom_sf(data = dom_wc_box_moll_buff, aes(group = mrgid), color = "black", fill = "lightblue2", size = 0.2)
# 
# test_plot2
```

# Add Shipping Channel 

We also need to incorporate a shipping channel bisecting the reserve that is 5 miles wild and directly perpendicular to Roseau. 

```{r}
# # Central latitude/longitude of Roseau - directly between the commercial shipping terminal and the cruise ship berth. 
# roseau_pt <- data.frame(loc = "E_mid")
# roseau_pt$geom = st_sfc(st_point(c(-61.391959, 15.299277)))
# 
# # Convert to sf object and assign crs
# roseau_pt_sf <- st_as_sf(roseau_pt)
# sf::st_crs(roseau_pt_sf) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
# roseau_pt_sf_moll <- roseau_pt_sf %>%
#   sf::st_transform(crs = st_crs(prj_moll)) # convert to Mollewide
# 
# # Create shippings lanes - Top and bottom should be 2.5 nm north and south of point respectively. Each lane is 1 nm, with 3 nm separation lane between them. 

```

# Summarize Reserve Options

```{r}
# Get area of each potential reserve
reserve_boundaries_sf <- box_coords_sf_moll %>%
  mutate(area_m2 = st_area(geom),
         area_km2 = as.numeric(area_m2)*1e-6)

# Save
save(reserve_boundaries_sf, file = file.path(here::here("results", "reserve_boundaries.Rdata")))
```



