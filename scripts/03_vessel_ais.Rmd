---
title: "Dominica: Process Commercial Vessel Tracks"
output: html_document
date: "2023-05-01"
---

```{r setup, include=FALSE}
# Libraries
library(lubridate)

# Load common helper script
source(here::here("common.R"))

# Define nautical miles in m
nm <- 1852

# Load reserve boundaries
load(here::here("results", "reserve_boundaries.Rdata"))

# Load sperm whale sightings
vessels <- read_csv(here::here("data", "shiny_vessels.csv")) %>%
  mutate(year = year(timestamp)) %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = 4326) %>%
  sf::st_transform(crs = st_crs(prj_moll)) # convert points to Mollewide
```

# Introduction

This script loads the database of vessel positions around Dominica from 2012 - 2019 shared with us by Shane Gero and determines the required distance to adjust each track such that the tracks fall outside of the 

```{r}
# Add scenario name
reserve_boundaries_sf <- reserve_boundaries_sf %>%
  mutate(scenario_name = paste0(W_lon, "Â°W"))

# Plot raw positions by vessel type. All over the place. 
ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "grey", size = 0.2)+
  geom_sf(data = vessels %>% dplyr::filter(year == 2019), size = 0.1, fill = "black")+
  geom_sf(data = reserve_boundaries_sf, aes(fill = scenario_name), alpha = 0.4)+
  coord_sf(xlim = plot_bbox$xlim, ylim = plot_bbox$ylim)+
  theme_basic()+
  facet_wrap(~vessel_type)
```

# Aggregate raw positions into "voyages"

It's unclear whether the AIS provided to us by Shane has been grouped into trips or voyages, so let's first check that and try to do this if needed. 

## Testing 

```{r}
# First let's find some vessels that have entries from more than one year
vessels_mult_years <- vessels %>%
  st_drop_geometry() %>%
  group_by(mmsi, category) %>%
  summarize(n_years = n_distinct(year)) %>%
  dplyr::filter(n_years > 1)

# Next, let's extract the first 10 vessels and do some testing
test_vessel_dat <- vessels %>%
  dplyr::filter(mmsi %in% vessels_mult_years$mmsi[1:10]) %>%
  group_by(mmsi) %>% 
  mutate(time_from_prev = timestamp - lag(timestamp)) %>%
  ungroup() %>%
  mutate(start_new_seg = case_when(is.na(time_from_prev) ~ T,
                                   time_from_prev > 60 ~ T),
         seg_id = ifelse(start_new_seg, paste0(mmsi, "_", timestamp), NA),
         seg_id = fill.na(seg_id)) %>%
  group_by(mmsi, seg_id) %>%
  mutate(dist_from_last = st_distance(lag(geometry), geometry, by_element = T),
         dist_to_next = st_distance(geometry, lead(geometry), by_element = T)) %>%
  ungroup() %>%
  mutate(dist_from_last = ifelse(!is.na(dist_from_last), dist_from_last, 0),
         dist_to_next = ifelse(!is.na(dist_to_next), dist_to_next, 0),
         dist = 0.5*dist_from_last + 0.5*dist_to_next)

# Now let's try grouping this by segment
test_seg_dat <- test_vessel_dat %>%
  group_by(mmsi, seg_id, vessel_type, category, year) %>%
  summarize(time_elapsed = last(timestamp) - first(timestamp),
            dist_traveled = sum(dist, na.rm = T)) %>%
  ungroup() %>%
  dplyr::filter(time_elapsed > 0 & dist_traveled > 0) # Remove segments with no time elapsed or distance traveled 

# Plot
ggplot()+
  geom_sf(data = dominica_eez_sf_moll, aes(group = mrgid), color = "black", fill = "grey", size = 0.2)+
  geom_sf(data = reserve_boundaries_sf, aes(fill = scenario_name), alpha = 0.4)+
  geom_sf(data = test_seg_dat, aes(group = seg_id), size = 0.2)+
  coord_sf(xlim = plot_bbox$xlim, ylim = plot_bbox$ylim)+
  theme_basic()
```

Ok, it looks like the process to segment positions and calculate distance traveled associated with each position is working. So let's go ahead and try to apply this to our most recent data... This might be a bit time consuming, so let's see how long it takes to do a single year first on my computer. This takes a long time - need to try a different approach. 

## 2018

```{r}
# Apply to 2018 positions only
positions_2018 <- vessels %>%
  dplyr::filter(year == 2018) %>%
  group_by(mmsi) %>% 
  mutate(time_from_prev = timestamp - lag(timestamp)) %>%
  ungroup() %>%
  mutate(start_new_seg = case_when(is.na(time_from_prev) ~ T,
                                   time_from_prev > 60 ~ T),
         seg_id = ifelse(start_new_seg, paste0(mmsi, "_", timestamp), NA),
         seg_id = fill.na(seg_id)) %>%
  group_by(mmsi, seg_id) %>%
  mutate(dist_from_last = st_distance(lag(geometry), geometry, by_element = T),
         dist_to_next = st_distance(geometry, lead(geometry), by_element = T)) %>%
  ungroup() %>%
  mutate(dist_from_last = ifelse(!is.na(dist_from_last), dist_from_last, 0),
         dist_to_next = ifelse(!is.na(dist_to_next), dist_to_next, 0),
         dist = 0.5*dist_from_last + 0.5*dist_to_next) %>%
  dplyr::select(mmsi, seg_id, timestamp, vessel_type, category, year, time_elapsed, dist)
  
```



